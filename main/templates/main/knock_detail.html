{% extends "base.html" %}

{% block content %}

<br/><h4>{{ object }}</h4>

<br/><h5>Status: {{ object.get_status_display }}</h5>

{% if object.assigned_to %}
    <br/>Assigned to: <a href="{% url 'profile' object.assigned_to.pk %}">{{ object.assigned_to }}</a>

    {% if object.work_stars %}
        <br/>User <a href="{% url 'profile' object.requester.pk %}">{{ object.requester }}</a> rated Worker <a href="{% url 'profile' object.assigned_to.pk %}">{{ object.assigned_to }}</a>: {{ object.get_work_stars_display }}
    {% endif %}
    {% if object.request_stars %}
        <br/>Worker <a href="{% url 'profile' object.assigned_to.pk %}">{{ object.assigned_to }}</a> rated User <a href="{% url 'profile' object.requester.pk %}">{{ object.requester }}</a>: {{ object.get_request_stars_display }}
    {% endif %}
{% endif %}

{% if user.is_authenticated %}
    {% if user.pk == object.requester.pk %}
        <br>
        {% comment %} <br><a href="{% url 'knock-update' object.pk %}">Edit</a> {% endcomment %}
        {% if object.status == 'O' or object.status == 'R' %}
            <br><a href="{% url 'knock-delete' object.pk %}">Delete</a>
        {% endif %}
    {% endif %}

    {% if user.pk != object.requester.pk and user not in object.submits.all and not object.assigned_to and perms.main.can_submit_for_knocks %}
        <br>
        <br><a href="{% url 'knock-submit' object.pk %}">Submit</a>
    {% endif %}

    {% if user.pk != object.requester.pk %}
        {% if not object.assigned_to or user.pk == object.assigned_to.pk %}
            <br>
            <br><a href="{% url 'chat' object.pk user.pk %}">Chat with {{ object.requester }}</a>
        {% endif %}
    {% endif %}

    {% if object.status == 'D' %}
        {% if user.pk == object.requester.pk and not object.work_stars or user.pk == object.assigned_to.pk and not object.request_stars %}
            <br>
            <br>
            <form action="{% url 'knock-rating' object.pk %}" method="post">
                {% csrf_token %}
                <label class="rating-label">
                    <p><strong>Rate for {{ object.assigned_to }}</strong></p>
                    <input
                    name="rating"
                    min="1"
                    max="5"
                    oninput="this.style.setProperty('--value', this.value)"
                    step="1"
                    type="range">
                </label>
                <input type="submit" value="Rate">
            </form>
        {% endif %}
    {% endif %}
{% endif %}

{% if not object.assigned_to and object.knocksubmit_set.count > 0 %}
    <br/>
    <br/>List of user submits:
    <ul>
        {% for knock_submit in object.knocksubmit_set.all|dictsort:"submit_time" %}
            {% if user.pk == knock.requester.pk %}
                <li>
                    <a href="{% url 'knock-assign_to' knock.pk knock_submit.user.pk %}">{{ knock_submit.user }} - {{ knock_submit.user.first_name }} {{ knock_submit.user.last_name }} submitted on <span title="{{ knock_submit.submit_time|date:"c" }}">{{ knock_submit.submit_time }}</span></a>
                    <a href="{% url 'chat' object.pk knock_submit.user.pk %}">Chat with {{ knock_submit.user }}</a>
                </li>
            {% else %}
                <li>
                    <a href="{% url 'profile' knock_submit.user.pk %}">{{ knock_submit.user }} - {{ knock_submit.user.first_name }} {{ knock_submit.user.last_name }}</a> submitted on <span title="{{ knock_submit.submit_time|date:"c" }}">{{ knock_submit.submit_time }}</span>
                </li>
            {% endif %}
        {% endfor %}
    </ul>
{% endif %}

{% if object.chats.count > 0 %}
    <br/>
    <br/>List of chats:
    <ul>
        {% for chat in object.chats.all %}
            <li><a href="{% url 'chat' chat.knock.pk chat.user.pk %}">{{ chat }}</a></li>
        {% endfor %}
    </ul>
{% endif %}

{% endblock content %}
